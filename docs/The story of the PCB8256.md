The story of the PCW8256
========================

A short history
---------------

Amstrad is a strange company. It's not as well-known a company as some of its contemporaries: Commodore, Sinclair, Atari. The computers it produces are not as highly regarded as those of the others either. This is a bit unfair, I think, heck, they even bought Sinclair after one too many bone-headed decisions by Sir Clive.

Amstrad started his career by producing low-end HiFi equipment. Their stick was to build things that looked expensive, but were in fact cheap. Back in the '70s and '80s, the way you listened to music was that you bought a record player, a radio an amplifier and a cassette deck. These you stacked on one another, creating your HiFi setup:

https://www.reddit.com/r/audio/comments/130kid6/what_happened_to_stereo_rack_systems_and_all_the/

At least that's what you did, if you had money. If you didn't that's what you aspired to do. So, if you were tight on cache, you went to Amstrad who would gave you a single box with all of these components in it: 

https://stereo2go.com/forums/threads/amscrap-amstrad-home-stereo.4979/
https://www.radiomuseum.org/r/amstrad_hifi_tower_system.html

This allowed for significant price-cuts. For instance, you didn't need four different power-supplies. You could remove a bunch of cables and connectors, even save on the case material. Just look at the internals of one of Amstrads products:


The integration (and the associated savings) is obvious. Yet, the styling of it was as if the components were still separate: cheap but looks expensive. Of course this gave them the smell of turd in the high-held noses of HiFi purists and snobs all over the world. Alan Sugar, the founder of Amstrad couldn't care less though as long as the money was flowing in. And flowing in it did.

So naturally, When it came to produce microcomputers, they followed the same strategy. Also naturally, they carried over their reputation for producing cheap crap. In this market however, there was a major difference: their main competitors did the same. Sir Sinclair was famous for his price-cutting measures. Same for Jack Tramil at the helm of Commodore. Yet, it seems only Amstrad got stuck with this reputation.

My experience with Amstrad computers started late. I came across their [CPC664](https://www.cpcwiki.eu/index.php/CPC_old_generation#CPC664) model in what must have been '92 or '93. I grew up on Commodore machines and by that time, I graduated to PC clones. Yet, I was impressed. This machine was pretty impressive for an 8-bitter: full-sized keyboard, built-in floppy drive, a semi-integrated monitor, built around a Z80 processor.

https://sansimeracomputers.wordpress.com/2014/06/21/30years-amstrad-cpc/amstrad-cpc664/

It looked a bit dated, and of course it *was* dated by that point. Still, it could run decent games in reasonable resolution and in color. It had the standard Basic interpreter in ROM and came with Logo on a floppy disk. Even more interesting to me at the time, it could also run CP/M.

Back to the present
-------------------

Now, why did I start caring about these machines in 2024? That's because of Zilogs decision to discontinue the Z80 line. I was working on UnIC already and was thinking about showcasing it with a retro-project. So the opportunity presented itself: use UnIC as a Z80 replacement. For that, I needed a retro-computer as the recipient of the organ-donation.

My thoughts immediately went for the CPC664. Soon however it became obvious that that particular machine is unobtanium and even its bigger brother, the CPC6128 is pretty damn expensive. This is when I've learned about another Amstrad line of machines, their 'serious' one, the [PCW](https://en.wikipedia.org/wiki/Amstrad_PCW) line.

https://en.wikipedia.org/wiki/Amstrad_PCW

These machines go on eBay for somewhat reasonable prices, especially if in the 'untested/for parts' condition. The default assumption with these machines of course is that they are broken, but I was after a cadaver anyway. So, soon enough I had a big box arrive at my front door.

I've turned the machine on and ... nothing. Well, not a big surprise there. Trouble-shooting for these things follow a rather predictable order: check power, check clocks, check reset, check bus activity, check memory. Oh, and check capacitors along the way. Rooting around the power supply, I soon realized that several rails were dead. Only the -24V power for the printer came up (yeah, this thing comes with a printer, but its powered by the monitor; the old Amstrad method in reality). Some digging around showed that one of the electrical fuses were busted.

<<<<Add schematic detail>>>>

This fuse kills the 12V supply rail, but along the way it also impacts the 5V one: even though the 5V gets generated by an independent secondary winding, the reference regulator for it gets supplied by the 12V rail. There were two options why the fuse could have died:

1. The fuse is simply busted and that's it
2. The fuse did it's job by blowing and there's something more substantially broken down-stream from it.

The fuse itself is protecting the main transformer - which I measured to be working. That component is custom-made for almost every power supply and irreplaceable by all accounts. So it's pretty important to figure out which one of the options I'm dealing with.

Luckily for a different project I bought a lab supply which had current limit and programmable voltage capability. I could easily sub it in right after the fuse and see safely test if things are in good shape. I set it's voltage to 12V and gradually increased the current limit. The voltage stabilized at around 0.5A. No smoke either; quite a relief.

So, it's the fuse then. I can buy replacement ones - and I really should - but for now, just shorting it will do.

At this point I could verify that the CPU was released from reset, that the clocks work clocking and the monitor came alive as well: I was greeted with a green glowing screen and ... nothing else.

First I was surprised by this, but later I've learned that this is normal: this machine doesn't have a traditional EPROM in it - which should have been obvious by visual inspection, but, you know...

Side-bar: the how to boot without a ROM?
----------------------------------------

So how could a machine boot without a boot ROM? Here's my reconstruction of what conspired, a rather ingenious design decision:

The machine has only a few major components: the CPU, memory, a central, custom gate-array, a floppy controller (split in two chips) and the printer interface.

<<<< add picture of PCB >>>>

It would have been a rather large cost-adder to include yet another component: an EPROM chip. However, since this machine always came with a floppy drive, one could get away with very little ROM; just enough to bootstrap from a floppy. A few hundred byte should suffice. But where to find a place for that? None of the chips I've listed have any permanent storage - even a custom ULA (https://www.alldatasheet.com/datasheet-pdf/pdf/121825/NEC/UPD65030.html) could not do that in those days. 

Or is there? You see, there's one thing I haven't told you yet: the printer controller chip is an 8041. This is the same thing that the PC/AT used for its keyboard interface. It is somewhat similar in spirit to what the very early PIC micro-controllers did and is billed as a "universal peripheral interface 8-bit microcomputer". It is a small micro-controller attached to some GPIOs and a bus-interface to talk to a bigger host processor.

https://www.cpu-galaxy.at/cpu/ram%20rom%20eprom/other_intel_chips/other_intel-Dateien/8041A_Datasheet.pdf

Crucially, it contains some ROM for it's own code. A whole 1kB of it. Now, if there's some space left in there, one could imagine using that leftover storage for bootstrapping the Z80.

There are two major problems to overcome. The first is that the 8041 can't expose its ROM to the host CPU. It can respond to requests, and given the right programming, that response could be a byte from the ROM, but it's going to be very slow. Somehow, the Z80 will have to be slowed down enough to be able to read the bytes from the 8041. This of course can be accomplished by pulling the WAIT_N pin low for long enough, something that the ULA can do.

The second problem is that, even if the 8041 is memory mapped, it can't decode more than two addresses: it has a single address line. So, how could the Z80 execute from this place? The answer is the following:

During boot, the chip-select for the 8041 is decoded to the whole (probably lower 1024 or so bytes) of the address space. A0 is driven to ********************* FIGURE OUT TO WHAT ******************. This way every read from that address region ends up on the 8041. It in turn responds by a series of bytes from it's ROM. This, when interpreted as Z80 instruction stream creates a trivial boot-loader. It can't do much of course. For instance, it can't use branches, loops, conditionals, etc. What it can do is to have a series of instructions that store content in RAM. That's easy, that's just a boring sequence of LDI instructions. When it's done, it can jump to the RAM location it just have written, where now the real boot-loader resides. The actual boot process is a little more complicated, but really just a little. You can see all the boring details documented here:

https://www.chiark.greenend.org.uk/~jacobn/cpm/pcwboot.html

Back to my particular machine: it did nothing interesting, but - again - not surprising. All this tiny boot-loader can do is to load the first sector from a floppy disk and execute it. I have no floppy disks for this machine not to mention that old floppy drives almost all had a belt drive, almost all of which dried out and broke a long time ago. So, a new belt needed to be ordered and floppies to be acquired, with the right content on them.

To make matters worse, the Amstrad machines are notorious to use a now extinct 3.0" floppy format. So, go through all of that, or ... get a GoTek: https://www.gotekemulator.com/

Once the drive arrived, I needed to set it up. One thing to do is to create an adapter ASAP: Amstrad or whoever made the 3.0" floppies in their infinite wisdom used the same 4-pin power connector as PCs did (and the Gotek uses), but reversed the location of the +5 and +12V supplies. That's not good if mixed up, thus the urgency.

The data connector is also (ever-so-slightly) different, so an [adapter cable](https://www.cpcwiki.eu/index.php/DIY:Floppy_Drives) is needed for that as well.

One thing not required, but nice is to replace the stock firmware with the much more user-friendly FlashFloppy (https://github.com/keirf/flashfloppy). Finding and downloading disk images turned out surprisingly difficult, I though these machines were better cared for on the Internet. There is a nice [PCW emulator](http://www.seasip.info/Unix/Joyce/index.html) out there though, which allowed me to make sure the images actually work (and see what they should be doing).

I had some trouble getting the jumper settings for the Gotek right, for quite a while nothing really happened. The trick was to put a jumper across the 'motor' or 'MO' jumper.

With that final tweak, the machine booted for the first time.

RAM issues
==========

All was good, until I started the basic interpreter. It reported some outrageous amount of free memory. Way more than what there was in the system. Typing in even the most simply program hung the system. Now, the first idea that comes to mind in such cases is bad memory. THe second would be bad power supply quality. Or in reverse order. Maybe. At any rate, since I was just in the power supplies, I knew they were stable and there aren't large electrolytics on the mainboard that could cause problems by drying out.

I tracked down a memory test program for CP/M <<<<<<<<< find the name of it !!!!! >>>>>>>>>, loaded and ... bang! Almost immediately errors started to fill the screen. Documentation wasn't the strong suite of programmers even back then, so I don't quite know what the reports mean, but the code (20) I thought would mean that bit 5 might be bad.

The memories called out on the schematic are 41256-es, very common 256kb memories. I have a stack of them from some previous project, I can't even recall. The chips are even socketed, so it should be easy. Since I have a bunch of these chips and I wasn't all that interested in tracking down which chip in particular was at fault, I replaced all 8. Rebooted and... The screen is all screwed up! Every character appeared to be printed twice. Yet, the machine booted all the way to CP/M. I could type. It wasn't really legible, but it certainly seemed to work. This is very strange. What kind of problem could cause this? It obviously had to do with the memory, but how can the CPU work perfectly well from the same memory that the video so patently can't. This is a mystery.

I failed to take a picture with all DRAM chips replaced, I only have one when all the odd bits are of the 41256 kind:

<<<< Add picture >>>>

It's a cool effect, if you asked me. In fact, if I was given this picture and asked to come up with a memory failure mode that results in it, I would be dumb-founded. Yet, here I was.

A closer investigation of the memory chips revealed that they are not 41256-s but 41257-s. What could the difference be? I was aware of various manufacturers giving their memory variants slightly different part numbers apparently just for the heck of it. Is it one fo those cases? Turns out it's not.

The 41257 is a special kind of DRAM, where page-mode addressing is replaced by CAS nibble addressing. Once a RAS cycle is started, up to four CAS pulses can be issued without changing the CAS address and 4 bits are output from four different addresses.

<<< Add picture >>>

This is in contrast with the 41256 chip, which needs a new CAS address for every CAS pulse:

<<<< Add picture >>>>

So, if I replaced the 41257-s with 41256-s, what I did was to repeat the same output twice (or four times, depending on how the PCW drives the chip) instead of outputting different data per the designs intention.

Furthermore, if this kind of special addressing is only used during video memory reads (which makes sense: the CPU can't do bursts, while the video is really ideal for it), this difference would only screw up video display.

Now that's fine and all, but where to find a replacement 41257? This is a rather special chip, not the garden variety 41256. Luckily I've found someone in France selling a few for a reasonable price, so - after a length process of crossing the Atlantic - I got my replacement chips.

While I was waiting, I took a scope-shot of the RAS and CAS signals going to the DRAM chips:

<<<< Add scope shot of RAS and CAS >>>>

You see four different cycles repeating one after the other:

1. A refresh cycle
2. A video memory read with the infamous second CAS pulse that uses the nibble-mode of the 41257
3. A normal memory cycle for the CPUs perusal
4. A second video memory read of the same kind as the first one

Each cycle lasts 250ns, so the repetition rate is 1MHz. To foreshadow something that comes much later: this means that the CPU only gets access to the memory every 4th clock cycle: the N_WAIT signal is a 25% duty-cycle, 1MHz wave. It also means that the system doesn't use the Z80s refresh cycles at all, those are wasted. Since the Z80 is absolutely memory-bound, this configuration must mean that the processor is running at a fraction (not exactly 1/4th, but close) of its full speed. Crazy to think that, especially because the machine feels responsive, not just in CP/M, but in it's word-processor and even in SymbOS <<<<Add link>>>>, a modern graphical OS.

The display
===========

The display resolution is 720x256. It otherwise follows TV timings, so the horizontal scan rate is 15.625kHz with the active period of 52us <<<<verify>>>>. This would mean a new byte needed to be read from memory every 570ns. The previous timing setup yields 4 bytes in 1us, or 1 byte every 250ns, twice the rate needed.

Why?

Very good question, especially considering how detrimental it is for CPU access.

It's not like the ULA with its 3312 total (NAND-2 equivalent) gates could do anything fancy, such as caching a scan-line.

Are we there yet?
=================

Sort of. With the fixed fuse, the replaced memory, the Gotek drive the machine was working. The only problem left was that it reported having 2 floppy drives. This was a bit of a problem and stem from the fact that the selection of the Gotek was solely based on the 'Motor ON' signal. An external OR gate (active-low AND logic) is needed to make sure the Gotek is only selected when both 'Motor On' and one of the 'Drive select' pins is active. This mod is detailed <<<<add link>>>> here. This is a circuit that I replicated myself with the exception of allowing the jumper-selection of which 'Drive-select' pin is used.

With that, the machine now thinks it only has a single drive, but for some reason still doesn't allow (or recognize really) the original floppy drive as a secondary drive. Because, yes, I did get my replacement belt and some floppy disks, so it would have been nice to be have both hooked up. Either way, it works, I even found a 3D printable design for a front-cover for the Gotek that fits in the 3" floppy opening on the PCW. Many thanks to my friend, Gabor with a 3D printer to print it out for me!

Putting all the pieces together have left me with - as far as I can tell - a perfectly functional PCW8256. Which allows for the second part of the saga: braking it with my UnIC Z80 replacement, but that is another tale for another day.
